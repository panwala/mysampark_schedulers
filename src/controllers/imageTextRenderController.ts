const frames = {
    data: [
        {
            id: 49,
            theam_name: "Majestic Elegance",
            text_color_1: "#ffffff",
            text_color_2: "#891804",
            x: "#ffffff",
            y: "#891804",
            font_type: "montserrat",
            is_publish: 1,
            created_at: "2025-03-19T07:42:56.000000Z",
            updated_at: "2025-03-19T07:42:56.000000Z",
            frames_varinat: [
                {
                    id: 410,
                    frame_id: 49,
                    frame_path: "variants/67978ef580d50.png",
                    no_of_lines: "5",
                    frame_variant_number: "7",
                    created_at: "2025-01-27T13:49:41.000000Z",
                    updated_at: "2025-01-27T13:49:41.000000Z",
                    image_url: "https://admin.mysampark.com/images/variants/67978ef580d50.png",
                    framesvariantline: [
                        {
                            id: 946,
                            variant_id: 410,
                            line_no: "1",
                            x: "227",
                            y: "114",
                            height: "47",
                            width: "622",
                            values: null,
                            created_at: "2025-01-27T13:49:41.000000Z",
                            updated_at: "2025-01-27T13:49:41.000000Z"
                        },
                        {
                            id: 947,
                            variant_id: 410,
                            line_no: "2",
                            x: "166",
                            y: "162",
                            height: "43",
                            width: "745",
                            values: null,
                            created_at: "2025-01-27T13:49:41.000000Z",
                            updated_at: "2025-01-27T13:49:41.000000Z"
                        },
                        {
                            id: 948,
                            variant_id: 410,
                            line_no: "3",
                            x: "287",
                            y: "205",
                            height: "40",
                            width: "501",
                            values: null,
                            created_at: "2025-01-27T13:49:41.000000Z",
                            updated_at: "2025-01-27T13:49:41.000000Z"
                        },
                        {
                            id: 949,
                            variant_id: 410,
                            line_no: "4",
                            x: "165",
                            y: "245",
                            height: "40",
                            width: "746",
                            values: null,
                            created_at: "2025-01-27T13:49:41.000000Z",
                            updated_at: "2025-01-27T13:49:41.000000Z"
                        },
                        {
                            id: 950,
                            variant_id: 410,
                            line_no: "5",
                            x: "223",
                            y: "286",
                            height: "45",
                            width: "627",
                            values: null,
                            created_at: "2025-01-27T13:49:41.000000Z",
                            updated_at: "2025-01-27T13:49:41.000000Z"
                        }
                    ]
                }
            ],
            frame_icon: {
                id: 76,
                frame_id: 49,
                name_icon: null,
                mobile_no_1_icon: "https://admin.mysampark.com/images/icons/67c53dca723f3.png",
                mobile_no_2_icon: "https://admin.mysampark.com/images/icons/67c53dca89dd5.png",
                email_icon: "https://admin.mysampark.com/images/icons/67c53dcaa1cdc.png",
                location_icon: "https://admin.mysampark.com/images/icons/67c53dcabb7b8.png",
                website_icon: "https://admin.mysampark.com/images/icons/67c53dcad1c05.png",
                instragram_icon: "https://admin.mysampark.com/images/icons/67c53dcaeaff2.png",
                created_at: "2025-03-19T07:42:56.000000Z",
                updated_at: "2025-03-19T07:42:56.000000Z"
            },
            frames_text_colour: {
                id: 564,
                frame_id: "49",
                variant_number: "7",
                line1: "Y",
                line2: "X",
                line3: "X",
                line4: "X",
                line5: "Y",
                created_at: "2025-03-19T07:42:56.000000Z",
                updated_at: "2025-03-19T07:42:56.000000Z"
            }
        },
        {
            id: 64,
            theam_name: "Vibrant Spectrum",
            text_color_1: "#052766",
            text_color_2: "#ffffff",
            x: "#052766",
            y: "#ffffff",
            font_type: "montserrat",
            is_publish: 1,
            created_at: "2025-03-19T07:47:59.000000Z",
            updated_at: "2025-03-19T07:47:59.000000Z",
            frames_varinat: [
                {
                    id: 738,
                    frame_id: 64,
                    frame_path: "variants/67da749de213d.png",
                    no_of_lines: "5",
                    frame_variant_number: "7",
                    created_at: "2025-03-19T10:40:07.000000Z",
                    updated_at: "2025-03-19T10:40:07.000000Z",
                    image_url: "https://admin.mysampark.com/images/variants/67da749de213d.png",
                    framesvariantline: [
                        {
                            id: 1766,
                            variant_id: 738,
                            line_no: "1",
                            x: "227",
                            y: "114",
                            height: "47",
                            width: "622",
                            values: null,
                            created_at: "2025-03-19T10:40:08.000000Z",
                            updated_at: "2025-03-19T10:40:08.000000Z"
                        },
                        {
                            id: 1767,
                            variant_id: 738,
                            line_no: "2",
                            x: "166",
                            y: "162",
                            height: "43",
                            width: "745",
                            values: null,
                            created_at: "2025-03-19T10:40:08.000000Z",
                            updated_at: "2025-03-19T10:40:08.000000Z"
                        },
                        {
                            id: 1768,
                            variant_id: 738,
                            line_no: "3",
                            x: "287",
                            y: "205",
                            height: "40",
                            width: "501",
                            values: null,
                            created_at: "2025-03-19T10:40:08.000000Z",
                            updated_at: "2025-03-19T10:40:08.000000Z"
                        },
                        {
                            id: 1769,
                            variant_id: 738,
                            line_no: "4",
                            x: "165",
                            y: "245",
                            height: "40",
                            width: "746",
                            values: null,
                            created_at: "2025-03-19T10:40:08.000000Z",
                            updated_at: "2025-03-19T10:40:08.000000Z"
                        },
                        {
                            id: 1770,
                            variant_id: 738,
                            line_no: "5",
                            x: "223",
                            y: "286",
                            height: "45",
                            width: "627",
                            values: null,
                            created_at: "2025-03-19T10:40:08.000000Z",
                            updated_at: "2025-03-19T10:40:08.000000Z"
                        }
                    ]
                }
            ],
            frame_icon: {
                id: 88,
                frame_id: 64,
                name_icon: null,
                mobile_no_1_icon: "https://admin.mysampark.com/images/icons/67c53dca723f3.png",
                mobile_no_2_icon: "https://admin.mysampark.com/images/icons/67c53dca89dd5.png",
                email_icon: "https://admin.mysampark.com/images/icons/67c53dcaa1cdc.png",
                location_icon: "https://admin.mysampark.com/images/icons/67c53dcabb7b8.png",
                website_icon: "https://admin.mysampark.com/images/icons/67c53dcad1c05.png",
                instragram_icon: "https://admin.mysampark.com/images/icons/67c53dcaeaff2.png",
                created_at: "2025-03-19T07:47:59.000000Z",
                updated_at: "2025-03-19T07:47:59.000000Z"
            },
            frames_text_colour: {
                id: 660,
                frame_id: "64",
                variant_number: "7",
                line1: "X",
                line2: "X",
                line3: "X",
                line4: "X",
                line5: "X",
                created_at: "2025-03-19T07:47:59.000000Z",
                updated_at: "2025-03-19T07:47:59.000000Z"
            }
        },
    ],
    line_content: {
        id: 97,
        combination_number: [
            1,
            2,
            3,
            4,
            5,
            6,
            7
        ],
        varinat_number: "7",
        frame_number: "97",
        line1: "1",
        line2: "2,3,4",
        line3: "5",
        line4: "6",
        line5: "7",
        created_at: "2025-03-25T06:52:09.000000Z",
        updated_at: null
    },
    globalfont: [
        {
            id: 91,
            "font_%": "100",
            font_weight: "800",
            type: "name",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 92,
            "font_%": "100",
            font_weight: "500",
            type: "mobile_no_1",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 93,
            "font_%": "100",
            font_weight: "500",
            type: "mobile_no_2",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 94,
            "font_%": "100",
            font_weight: "700",
            type: "email",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 95,
            "font_%": "100",
            font_weight: "500",
            type: "address",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 96,
            "font_%": "100",
            font_weight: "500",
            type: "website",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        },
        {
            id: 97,
            "font_%": "100",
            font_weight: "500",
            type: "instagram",
            type_number: null,
            font_size: "16",
            created_at: "2025-03-26T12:39:09.000000Z",
            updated_at: "2025-03-26T12:39:09.000000Z"
        }
    ],

}


const user = {
    id: 5,
    logo_image: "https://admin.mysampark.com/images/1738047526.67988026b1ad8.jpg",
    business_name: "Test7 Business Solutions", // 20 characters
    owner_name: "John Doe",
    mobile_no: "1234567890", // 10 characters
    second_mobile_no: "9876543210", // 10 characters
    email: "johndoe.business.contact@gmail.com", // 30 characters
    website: "https://www.businesswebsite.com", // 30 characters
    address: "CTM2323, 42nd Street, Downtown, Business Complex, City Center", // 60 characters
    state: "California",
    user_id: "5",
    mobile_no_2: "7339928167", // 10 characters
    post_schedult_time: "22:00:00",
    is_sameday: 0,
    instragram_id: "sdf sdf fdsadf dbusinesspage", // 30 characters
    variant_number: [1, 6, 12, 24, 48, 96],
    business_category_id: 27,
    bussiness_category_name: "Retail & E-Commerce Solutions",
    status: "0",
    whatsapp_number2: "5555555555", // 10 characters
    is_sendpostnumber: 0
};




import { createCanvas, loadImage, registerFont } from 'canvas';

// Define font paths
const fontPath = "./public/font";

registerFont(`${fontPath}/montserrat/Montserrat-Regular.ttf`, { family: "Montserrat", weight: "normal" });
registerFont(`${fontPath}/montserrat/Montserrat-Bold.ttf`, { family: "Montserrat", weight: "bold" });
registerFont(`${fontPath}/montserrat/Montserrat-Medium.ttf`, { family: "Montserrat", weight: "500" });
registerFont(`${fontPath}/montserrat/Montserrat-Light.ttf`, { family: "Montserrat", weight: "300" });
registerFont(`${fontPath}/montserrat/Montserrat-Thin.ttf`, { family: "Montserrat", weight: "100" });
registerFont(`${fontPath}/montserrat/Montserrat-ExtraBold.ttf`, { family: "Montserrat", weight: "800" });
registerFont(`${fontPath}/montserrat/Montserrat-SemiBold.ttf`, { family: "Montserrat", weight: "600" });
registerFont(`${fontPath}/montserrat/Montserrat-Black.ttf`, { family: "Montserrat", weight: "900" });



export const imageTextRenderController = async (req, res) => {

    // Replace with frames dynamic data
    const framesData = frames

    // Replace with users dynamic data
    const userData = user

    try {
        // Extracting required data from provided datasets
        const lineContent = framesData.line_content;
        const globalFont = framesData.globalfont;
        const frameData = framesData.data[1];
        const framesTextColour = frameData.frames_text_colour;
        const framesVariantData = frameData.frames_varinat[0];
        const framesVariantLines = framesVariantData.framesvariantline;
        const fontFamily = frameData.font_type;

        // Business-related text data to be rendered on the image
        const businessData = [
            userData.business_name,
            userData.mobile_no,
            userData.mobile_no_2,
            userData.instragram_id,
            userData.email,
            userData.address,
            userData.website
        ];

        // Load background image
        const backgroundImage = await loadImage(framesVariantData.image_url);
        const canvas = createCanvas(backgroundImage.width, backgroundImage.height);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(backgroundImage, 0, 0);


        // Load icons for different business details
        const icons = {
            email: await loadImage(frameData.frame_icon.email_icon),
            mobile1: await loadImage(frameData.frame_icon.mobile_no_1_icon),
            mobile2: await loadImage(frameData.frame_icon.mobile_no_2_icon),
            location: await loadImage(frameData.frame_icon.location_icon),
            website: await loadImage(frameData.frame_icon.website_icon),
            instagram: await loadImage(frameData.frame_icon.instragram_icon),
        };


        // Extract relevant font settings for different text elements
        const fontsData = [
            globalFont.find(f => f.type === "name"),
            globalFont.find(f => f.type === "mobile_no_1"),
            globalFont.find(f => f.type === "mobile_no_2"),
            globalFont.find(f => f.type === "instagram"),
            globalFont.find(f => f.type === "email"),
            globalFont.find(f => f.type === "address"),
            globalFont.find(f => f.type === "website"),
        ].filter(f => f !== undefined);

        // Extract text colors and group lines for rendering
        const textColours = [
            framesTextColour.line1,
            framesTextColour.line2,
            framesTextColour.line3,
            framesTextColour.line4,
            framesTextColour.line5
        ].filter(f => f !== null);


        const groupOfLines = [
            lineContent.line1,
            lineContent.line2,
            lineContent.line3,
            lineContent.line4,
            lineContent.line5
        ].filter(f => f !== null);



        // Loop through each text section and render it on the image
        framesVariantLines.forEach((row, index) => {
            let fontSize = +fontsData[0]?.font_size || 12;
            const fontWeight = 'normal';
            const iconSize = fontSize * 2;

            ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
            ctx.fillStyle = textColours[index] === "Y" ? frameData.y : frameData.x;

            // Split lines of current row
            const linesOfCurrentRow = groupOfLines[index].split(",");

            // Map business data to their respective text slots
            const texts = linesOfCurrentRow.map(line => {
                const lineText = businessData[+line - 1];
                return { lineNo: +line, text: lineText || "" };
            }).filter(f => f !== null);

            // Calculate total width of all text elements combined
            const totalTextWidth = index === 0 ? texts.reduce((sum, text) => sum + ctx.measureText(text.text).width, 0) : texts.reduce((sum, text) => sum + ctx.measureText(text.text).width, 0) + iconSize;
            const spacing = (+row.width - totalTextWidth) / (texts.length + 1)
            let xPos = +row.x + spacing

            // ctx.strokeStyle = "red";
            // ctx.lineWidth = 2;
            // ctx.strokeRect(xPos, +row.y, +row.width, +row.height);

            // Render text and icons
            texts.forEach((text) => {
                const getFontSize = fontsData[text.lineNo - 1];
                const fontWeight = +getFontSize.font_weight || 'normal';
                ctx.font = `${fontWeight} ${+getFontSize.font_size}px ${fontFamily}`;
                fontSize = +getFontSize.font_size;

                // Assign appropriate icon for each text line
                let icon;
                switch (text.lineNo) {
                    case 2: icon = icons.mobile1; break;
                    case 3: icon = icons.mobile2; break;
                    case 4: icon = icons.instagram; break;
                    case 5: icon = icons.email; break;
                    case 6: icon = icons.location; break;
                    case 7: icon = icons.website; break;
                    default: icon = null;
                }

                // Calculate text position
                const yPos = +row.y + +row.height / 2 + fontSize / 3;
                const textWidth = ctx.measureText(text.text).width;

                // Draw icon and text
                if (icon) {

                    ctx.drawImage(icon, +xPos, +yPos - iconSize / 1.5, iconSize, iconSize);
                    ctx.fillText(text.text, +xPos + iconSize, +yPos);
                    xPos += textWidth + spacing;
                } else {
                    ctx.fillText(text.text, +xPos, +yPos);
                    xPos += textWidth + spacing
                }


            });
        });

        // Set response headers and send the image
        res.setHeader('Content-Type', 'image/png');
        res.send(canvas.toBuffer('image/png'));

    } catch (error) {
        res.status(500).json({ message: "Internal Server Error", error: error.message });
    }
};
